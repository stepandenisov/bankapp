<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Корзина товаров</title>
    <style>
        .custom-toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 16px;

            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 9999;
        }

        .custom-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
    <script>
        const eventSource = new EventSource("/sse/notifications");

        eventSource.addEventListener("notification", function (event) {
            const data = JSON.parse(event.data);
            sessionStorage.setItem("toastMessage", data.message);
            showToast(data.message);
        });

        eventSource.onerror = function (err) {
            console.error("SSE error", err);
        };

        function showToast(message, duration = 5000) {
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.innerHTML = `
            <div class="toast">
                <div class="toast-header">
                    <strong>Уведомление</strong>
                    <button class="close-btn" aria-label="Закрыть">&times;</button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);

            const timeoutId = setTimeout(() => removeToast(), duration);

            toast.querySelector('.close-btn').addEventListener('click', () => {
                clearTimeout(timeoutId);
                removeToast();
            });

            function removeToast() {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => {
                    toast.remove();
                }, { once: true });
            }
        }
    </script>
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            const message = sessionStorage.getItem("toastMessage");
            if (message) {
                showToast(message);
                sessionStorage.removeItem("toastMessage");
            }
        });
    </script>
    <script language="JavaScript">
        setInterval(() => {
            var td = document.getElementById('exchange_rates');
            fetch('http://localhost:8085/rate', {
                method: 'GET',
                mode: 'cors'
            })
                .then(response => response.json())
                .then(json => json.rate)
                .then(json => {
                    var table = '<table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">';
                    table += '<tr><th colspan="3">Курсы валют по отношению к рублю</th></tr>';
                    table += '<tr><th>Валюта</th><th>Курс</th></tr>';
                    json.forEach(rate => {
                        table += '<tr>';
                        table += '<td>' + rate.currency + '</td>';
                        table += '<td>' + rate.value + '</td>';
                        table += '</tr>';
                    });
                    table += '</table>';
                    td.innerHTML = table;
                })
                .catch(error => td.innerHTML = error);
        }, 1000);
    </script>
<!--    <script language="JavaScript">-->
<!--        async function fetchRates() {-->
<!--            const td = document.getElementById('exchange_rates');-->
<!--            const urls = [-->
<!--                'http://localhost:8080/exchange/rate',-->
<!--                'http://gateway:8080/exchange/rate'-->
<!--            ];-->

<!--            for (let url of urls) {-->
<!--                try {-->
<!--                    const response = await fetch(url, { method: 'GET'});-->
<!--                    if (!response.ok) throw new Error(`HTTP error: ${response.status}`);-->
<!--                    const data = await response.json();-->
<!--                    return data.rate;-->
<!--                } catch (err) {-->
<!--                    console.warn(`Не удалось получить данные по адресу ${url}:`, err);-->
<!--                }-->
<!--            }-->

<!--            throw new Error('Не удалось получить данные ни с одного источника');-->
<!--        }-->

<!--        setInterval(async () => {-->
<!--            const td = document.getElementById('exchange_rates');-->

<!--            try {-->
<!--                const rates = await fetchRates();-->
<!--                let table = `-->
<!--                <table style="width:100%;margin:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">-->
<!--                    <tr><th colspan="2">Курсы валют по отношению к рублю</th></tr>-->
<!--                    <tr><th>Валюта</th><th>Курс</th></tr>-->
<!--            `;-->
<!--                rates.forEach(rate => {-->
<!--                    table += `<tr><td>${rate.currency}</td><td>${rate.value}</td></tr>`;-->
<!--                });-->
<!--                table += '</table>';-->
<!--                td.innerHTML = table;-->
<!--            } catch (error) {-->
<!--                td.innerHTML = `<p style="color:red;">Ошибка загрузки данных: ${error.message}</p>`;-->
<!--            }-->
<!--        }, 1000);-->
<!--    </script>-->

</head>

<body>
<a href="/signup" style="float:right;">
    <b>РЕГИСТРАЦИЯ &plus;</b>
</a>
<br>
<a href="/logout" style="float:right;">
    <b>ВЫЙТИ &cudarrr;</b>
</a>
<table style="width:70%;margin-left:auto;margin-right:auto;">
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/password'}" enctype="multipart/form-data">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr>
                        <td style="font-weight:bold;">Логин</td>
                        <!--                <td colspan="2" th:text="${login}"/>-->
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Изменить пароль</td>
                        <td>
                            <p style="color:red;" th:if="${passwordErrors!=null}"
                               th:each="passwordError : ${passwordErrors}" th:text="${passwordError}"/>
                            <p>
                                Пароль: <input name="password" type="password" required/>
                            </p>
                            <p>
                                Повторите пароль: <input name="confirmPassword" type="password" required/>
                            </p>
                        </td>
                        <td style="text-align:right">
                            <button>Изменить пароль</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/user/info'}" enctype="multipart/form-data">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${userAccountsErrors!=null}" th:each="userAccountsError : ${userAccountsErrors}">
                        <td style="color:red;" th:text="${userAccountsError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Фамилия Имя</td>
                        <td th:text="${name}"/>
                        <td>
                            <input name="name" type="text" style="width:100%"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Дата рождения</td>
                        <td th:text="${birthday}"/>
                        <td>
                            <input name="birthday" type="date" style="width:100%"/>
                        </td>
                    </tr>
                    <tr>
                        <td style="text-align:right" colspan="3">
                            <button>Сохранить изменения</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <table style="width:100%; background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
                <tr th:each="account : ${accounts}">
                    <td style="font-weight:bold;" th:text="${account.getCurrency().name()}"></td>
                    <td th:text="${account.getReminder() + ' ' + account.getCurrency().name()}"></td>
                    <td style="text-align:right">
                        <form th:action="@{'/accounts/' + ${account.getId()} + '/delete'}" method="post"
                              th:object="${account}">
                            <button type="submit" onclick="return confirm('Удалить счет?')">Удалить</button>
                        </form>
                    </td>
                </tr>
            </table>
            <form method="post" th:action="@{/accounts}" enctype="multipart/form-data">
                <table style="width:100%; background-color: #f9f9f9; padding: 10px; border-radius: 5px;">
                    <tr>
                        <td style="font-weight:bold;">Добавить счет</td>
                        <td>
                            <select name="currency" required>
                                <option value="" disabled selected>Выберите валюту</option>
                                <option th:each="eachCurrency : ${availableCurrencies}"
                                        th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.name()}">
                                </option>
                            </select>
                        </td>
                        <td style="text-align:right">
                            <button type="submit">Добавить</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/cash'}" enctype="multipart/form-data">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${cashErrors!=null}" th:each="cashError : ${cashErrors}">
                        <td style="color:red;" th:text="${cashError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Наличные</td>
                        <td>
                            Валюта
                            <select name="accountId">
                                <option th:each="account : ${accounts}" th:value="${account.getId()}"
                                        th:text="${account.getCurrency().name()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="volume" type="number" style="width:100%" required/>
                        </td>
                        <td>
                        <td style="text-align:right">
                            <button name="action" value="PUT">Положить</button>
                            <button name="action" value="GET">Снять</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/transfer/self'}" enctype="multipart/form-data">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferErrors!=null}" th:each="transferError : ${transferErrors}">
                        <td style="color:red;" th:text="${transferError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод себе</td>
                        <td>
                            Со счета
                            <select name="fromAccountId">
                                <option th:each="account : ${accounts}" th:value="${account.getId()}"
                                        th:text="${account.getCurrency().name()}"/>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="toAccountId">
                                <option th:each="account : ${accounts}" th:value="${account.getId()}"
                                        th:text="${account.getCurrency().name()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="amount" type="number" style="width:100%" required/>
                        </td>
                        <td style="text-align:right">
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;">
            <form method="post" th:action="${'/transfer/external'}">
                <table style="width:100%;margin-left:auto;margin-right:auto;border-radius:2%;padding:10px;background-color:whitesmoke;">
                    <tr th:if="${transferOtherErrors!=null}" th:each="transferOtherError : ${transferOtherErrors}">
                        <td style="color:red;" th:text="${transferOtherError}"/>
                    </tr>
                    <tr>
                        <td style="font-weight:bold;">Перевод другому</td>
                        <td>
                            Со счета
                            <select name="fromAccountId">
                                <option th:each="account : ${accounts}" th:value="${account.getId()}"
                                        th:text="${account.getCurrency().name()}"/>
                            </select>
                        </td>
                        <td>
                            На счет
                            <select name="toCurrency">
                                <option th:each="eachCurrency : ${currency}" th:value="${eachCurrency.name()}"
                                        th:text="${eachCurrency.name()}"/>
                            </select>
                        </td>
                        <td>
                            <input name="amount" type="number" required/>
                        </td>
                        <td>
                            Кому
                            <select name="userId">
                                <option th:each="user : ${users}" th:value="${user.id()}"
                                        th:text="${user.fullName()}"/>
                            </select>
                        </td>
                        <td style="text-align:right">
                            <button>Перевести</button>
                        </td>
                    </tr>
                </table>
            </form>
        </td>
    </tr>
    <tr>
        <td style="padding:2px;" id="exchange_rates">
        </td>
    </tr>
</table>
</body>

</html>
